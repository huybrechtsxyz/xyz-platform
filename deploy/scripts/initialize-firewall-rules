# Firewall rules for a Docker Swarm cluster
# This script is designed to be used with a firewall management tool like `ufw`
# It sets up rules to allow necessary traffic for a Docker Swarm

# Deny all traffic by default
--force reset
default deny incoming
default deny outgoing

# Essential System Services
allow out 53/tcp comment 'DNS (TCP)'
allow out 53/udp comment 'DNS (UDP)'
allow out 123/udp comment 'NTP'

# Loopback
allow in on lo comment 'Loopback IN'
allow out on lo comment 'Loopback OUT'

# Package Management (Optional)
allow out 20,21/tcp comment 'FTP'
allow out 11371/tcp comment 'GPG keyserver'

# Web & SSH
allow 22/tcp comment 'SSH'
allow 80/tcp comment 'HTTP'
allow 443/tcp comment 'HTTPS'
allow out 80/tcp comment 'HTTP'
allow out 443/tcp comment 'HTTPS'

# SSH Outbound to internal nodes
allow out proto tcp to 10.0.0.0/23 port 22 comment 'SSH Outbound to internal nodes'

# Docker Swarm management traffic (TCP) over VLAN
allow proto tcp from 10.0.0.0/23 to any port 2377 comment 'Swarm Control IN'
allow out proto tcp to 10.0.0.0/23 port 2377 comment 'Swarm Control OUT'

# Docker VXLAN overlay network (UDP) over VLAN
allow proto udp from 10.0.0.0/23 to any port 4789 comment 'Swarm Overlay Network IN'
allow out proto udp to 10.0.0.0/23 port 4789 comment 'Swarm Overlay Network OUT'

# Docker overlay network discovery (TCP + UDP) over VLAN
allow proto tcp from 10.0.0.0/23 to any port 7946 comment 'Swarm Discovery TCP'
allow proto udp from 10.0.0.0/23 to any port 7946 comment 'Swarm Discovery UDP'
allow out proto tcp to 10.0.0.0/23 port 7946 comment 'Swarm Gossip TCP OUT'
allow out proto udp to 10.0.0.0/23 port 7946 comment 'Swarm Gossip UDP OUT'

# Postgres traffic between nodes
allow proto tcp from 10.0.0.0/23 to any port 5432 comment 'Postgres IN'
allow out proto tcp to 10.0.0.0/23 port 5432 comment 'Postgres OUT'

# Redis traffic between nodes
allow proto tcp from 10.0.0.0/23 to any port 6379 comment 'Redis IN'
allow out proto tcp to 10.0.0.0/23 port 6379 comment 'Redis OUT'
